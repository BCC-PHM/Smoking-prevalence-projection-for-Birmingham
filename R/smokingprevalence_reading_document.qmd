---
title: "Smoking prevalence projection for Birmingham"
author: "Chung Au-Yeung"
bibliography: "references.bib"
csl: elsevier-vancouver
editor: visual
execute:
  echo: false
  message: false
  warning: false
  fig-width: 10
  fig-height: 8
format: 
  html:
    embed-resources: true
    toc: true
    toc-location: left
    number-sections: true
---

## Introduction

Birmingham Public Health has expanded community stop smoking services through the Smokefree Generation grant, marking a major step forward in the national journey towards becoming smokefree by 2030. The initiative expands capacity for cessation services in communities where smoking prevalence remains high and introduces targeted interventions for groups disproportionately affected by tobacco use—particularly those experiencing mental illness, substance use, or homelessness.

While these initiatives strengthen local cessation capacity, reducing smoking prevalence across all communities requires sustained monitoring. This report aims at developing a model to project the smoking prevalence in Birmingham till 2047, allowing the local team to track progress toward the 2030 target. The model will also allow scenario testing to assess the potential impact of future policies or interventions.

## Method

### Data

This projection draws upon publicly available data from multiple reputable sources. Population and migration estimates for Birmingham up to 2047 were obtained from the Office for National Statistics (ONS) 2022-based subnational population projections [@ONS_2025_subnational_population_projections]. Smoking prevalence data were collated from several national datasets, including Adult Smoking Habits in England (ONS) [@ONS_2023_adult_smoking_habits_gb], Smoking, Drinking and Drug Use among Young People in England 2023 (NHS Digital) [@NHS_Digital_2023_sdd_youth_england], and the Profile of 16–17-year-old Smokers from Action on Smoking and Health (ASH) [@ASH_2021_profile_16_17_smokers].

In each simulation cycle, a new cohort of 13-year-olds is introduced as non-smokers. As smoking prevalence at this age is negligible, therefore, the model assumes no 13-year-olds smoke. The injection of new cohort of 13-year-olds for each simulation cycle is obtained from ONS subnational projection [@ONS_2025_subnational_population_projections].

In each cycle, individuals can die from any states. The all-cause mortality rates were derived from the national life tables 2021-2023 [@ONS_2024_national_life_tables] and subsequently averaged across the three smoking status groups: non-smokers, current smokers, and ex-smokers. uses the equation from a prior study to calculate the death risk for non-smoker [@Song380], as shown below:

$$ P_{d0} = \frac{P_{d\text{all}}}{P_{r\text{non}} + P_{r\text{cur}} \times R_{\text{cur}} + P_{r\text{ex}} \times R_{\text{ex}}} $$

$P_{d\text{all}}$ is the all cause mortality rate while $P_{d\text{rnon}}$, $P_{d\text{rcur}}$ and $P_{d\text{rex}}$ are prevalence of non-smoker, current smoker and ex-smoker respectively. The mortality rate for current smoker are elevated by the relative risk $R_{d\text{cur}}$ and therefore, the rate is $P_{d0} \times R_{\text{cur}}$. Correspondingly, the mortality rate for ex-smoker will be $P_{d0} \times R_{\text{ex}}$. The relative risks of death for current and ex-smokers were obtained from published literature [@JEON2023S53]. As relative risk vary according to duration since quitting (e.g., short-term vs. long-term cessation) and age at quitting, there will have different combinations of relative risks. However, the model used in this analysis does not account for age at cessation or distinguish between short- and long-term quitters. Therefore, the relative risk for ex-smokers was based on estimates corresponding to long-term quitters. Furthermore, the model includes 10 sub-states for ex-smokers, corresponding to the number of years since quitting. These sub-states allow ex-smokers to experience a diminishing probability of relapse over time, reflecting evidence that the likelihood of returning to smoking decreases with the duration of abstinence.

The transition probabilities among states in the Markov model were specific to age and gender. These probabilities were obtained an estimation produced from cross-sectional survey by the University of Sheffield [@Gillespie_et_al_smktrans]. The original probabilities were reported by Index of Multiple Deprivation (IMD) quintile. In order to generate an overall estimate representative of Birmingham, a weighted average was calculated using the population distribution of smokers across IMD deciles within the city. Since smoking overall has being following a downward trend in recent years and this pattern is expected to persist, it is possible that the smoking prevalence could plateau or even increase, similar to trend being observed in Australia and US. Therefore, this analysis follows the Department of Health & Social Care (DHSC)'s method [@DHSC_2023_smokefree_generation_modeling] to fix the transition probabilities at 2022 estimate through out the simulation. With regards to DHSC's method again, a long-term quit probability was applied to ex-smokers who had remained abstinent for 10 years, allowing them to transition to the non-smoker state. This implies that a proportion of ex-smokers will share the same health risk as the non-smokers.

In order to follow the DHSC's method as closely as possible, instigation rates for 13- to 15-year-olds were calculated using a scaling approach. This was carried out by referencing the instigation rates for males and females from the US SimSmoke model [@CISNET], applying the assumption that the ratio between adjacent age groups in the US model also applies to the Birmingham population.

### Model structure

This analysis employed an open-cohort Markov model to simulate the natural history of smoking behaviour for those who are above 13 years old in Birmingham. The model includes annual cycles and a finite time horizon of 25 years. The model started at time 0 using the number of population in 2022. Smoking status was classified into non-smokers, current smokers and ex-smokers. At the start of each annual cycle, the distribution of smoking status among these entrants is determined in proportion to observed smoking prevalence data for this age group. Simultaneously, the model incorporates net migration by smoking status. For simplicity, it is assumed that the smoking distribution of migrants mirrors that of the UK population.

![**Figure 1.** Markov state transition diagram for smoking prevalence](images/statetransition.png){fig-align="center" fig-cap-align="center"}

```{r setup}
library(tidyverse)
library(readr)
library(readxl)
library(writexl)
library(ggiraph)
library(RColorBrewer)
```

## Results

### Baseline result

Applying the baseline transition probabilities to the initial population produces the baseline scenario, representing outcomes in the absence of any policy intervention. The result is comparable to the DHSC's published model, showing a similar trend and similar prevalence. The first cycle of the model in 2023 shows the the smoking prevalence for those among 14 to 30 year old is 11.35%. Without any additional policies being implemented, the smoking prevalence in Birmingham is estimated to reach 11% in 2047.

The trend is most likely similar to the published DHSC's model where both models reached the long run equilibrium very quickly in the year of 2028 but the change in the rate was significantly slower for Birmingham. This difference can largely be attributed to demographic and socio-economic factors. Birmingham has a younger population structure, both in the 2022 baseline and in the subnational population projections to 2047 produced by the ONS, compared with England overall. A younger age profile implies a larger proportion of individuals in age groups with higher initiation rates and lower long-term cessation, thereby moderating the overall decline.

In addition, the quit and relapse probabilities in this model were calculated as a weighted average by deprivation quintile. Given Birmingham is one of the most deprived local authorities, the quit and relapse rates are lower relative to the national average. Consequently, less individuals quit and more individuals transition back from ex-smoker to current smoker states, resulting in a slower early decline in prevalence before reaching equilibrium.

```{r}
#| echo: false
all_scenario <- read_excel("C:/Users/TMPACGAG/OneDrive - Birmingham City Council/Documents/R projects/addiction team/smoking prevalence projection/result/all_scenario.xlsx")

plot1 = all_scenario%>%
  mutate(State_new = State,
         State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
  filter(State_new!= "Deaths") %>% 
  filter(Age %in%c(14:30)) %>% 
  group_by(Year, State_new,Scenario) %>%
  summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
  mutate(newgroup = ifelse(State_new == "Current smoker",
                           "Current smoker",
                           "Former and non")) %>% 
  group_by(Year,newgroup ,Scenario) %>% 
  summarise(numerator = sum(Total)) %>% 
  ungroup() %>% 
  group_by(Year,Scenario) %>% 
  mutate(denominator =sum(numerator)) %>% 
  ungroup() %>% 
  filter(newgroup == "Current smoker") %>% 
  mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
  filter(Scenario == 0, Year>=2023) %>% 
  mutate(tooltip = paste0("Year: ", Year,"\n",
                          "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")) %>% 
  ggplot(aes(x = Year, y = smoking_prev, group = factor(Scenario), colour = factor(Scenario))) +
  geom_line_interactive(size=1, aes(data_id = Year), colour = "#3c3c3b")+
  geom_point_interactive(aes(tooltip = tooltip, data_id = Year),colour="#3c3c3b")+
   theme_minimal(base_size = 14)+
  scale_y_continuous(limits = c(0,0.15), labels = scales::percent)+
  scale_x_continuous(breaks = c(2023:2047))+
  labs(title = "Modelled baseline smoking prevalence in Birmingham among 14 to 30 year olds, \n2023 to 2047",
       y="Prevalence") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle=45),
        legend.position = "bottom")

  
#custom css
tooltip_css = "
  border-radius: 12px;
  color: #333;
  background-color: white;
  padding: 10px;
  font-size: 14px;
  transition: all 0.5s ease-out;
"
girafe( ggobj = plot1, 
        options = list( opts_hover(css=" "), 
                        opts_hover_inv(css = girafe_css( css = "opacity:0.4;",
                                                         line = "opacity:0.075;", 
                                                         point = "opacity:0.075;" )), 
                        opts_tooltip(css = tooltip_css) ))














  
```

The baseline result for adults (18+) is comparable to the model produced by Cancer Research UK. The first cycle of the model in 2023 shows the the smoking prevalence for adults is 13.06%. Without any additional policies being implemented, the smoking prevalence in Birmingham is estimated to reach 6.4% in 2047. While the trend is most likely similar to the one from Cancer Research UK [@CRUK_2021_smoking_prevalence_projections], their model produced a faster declining rate, the same reasons from the above can explain such deviation.

```{r}
#| echo: false


all_scenario <- read_excel("C:/Users/TMPACGAG/OneDrive - Birmingham City Council/Documents/R projects/addiction team/smoking prevalence projection/result/all_scenario.xlsx")

plot18above = all_scenario%>%
  mutate(State_new = State,
         State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
  filter(State_new!= "Deaths") %>% 
  filter(Age %in%c(18:100)) %>% 
  group_by(Year, State_new,Scenario) %>%
  summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
  mutate(newgroup = ifelse(State_new == "Current smoker",
                           "Current smoker",
                           "Former and non")) %>% 
  group_by(Year,newgroup ,Scenario) %>% 
  summarise(numerator = sum(Total)) %>% 
  ungroup() %>% 
  group_by(Year,Scenario) %>% 
  mutate(denominator =sum(numerator)) %>% 
  ungroup() %>% 
  filter(newgroup == "Current smoker") %>% 
  mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
  filter(Scenario == 0, Year>=2023) %>% 
  mutate(tooltip = paste0("Year: ", Year,"\n",
                          "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")) %>% 
  ggplot(aes(x = Year, y = smoking_prev, group = factor(Scenario), colour = factor(Scenario))) +
  geom_line_interactive(size=1, aes(data_id = Year), colour = "#3c3c3b")+
  geom_point_interactive(aes(tooltip = tooltip, data_id = Year),colour="#3c3c3b")+
   theme_minimal(base_size = 14)+
  scale_y_continuous(limits = c(0,0.15), labels = scales::percent)+
  scale_x_continuous(breaks = c(2023:2047))+
  labs(title = "Modelled baseline smoking prevalence in Birmingham 18+, 2023 to 2047",
       y="Prevalence") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle=45),
        legend.position = "bottom")

  
#custom css
tooltip_css = "
  border-radius: 12px;
  color: #333;
  background-color: white;
  padding: 10px;
  font-size: 14px;
  transition: all 0.5s ease-out;
"
girafe( ggobj = plot18above, 
        options = list( opts_hover(css=" "), 
                        opts_hover_inv(css = girafe_css( css = "opacity:0.4;",
                                                         line = "opacity:0.075;", 
                                                         point = "opacity:0.075;" )), 
                        opts_tooltip(css = tooltip_css) ))












```

### Scenario

This analysis followed the scenario where the Tobacoo and Vape bill [@UK_Parliament_2024_Tobacco_Vapes_Bill] that has passed the second reading in House of Lords will be successfully implemented in the proposed date on the 1st of January 2027 [@DHSC_2024_tobacco_vapes_policy]. The bill aims to prohibit the sale of tobacco to people born on or after 1 January 2009 and provision about the licensing of retail sales and the registration of retailers, alongside enforcement measures and financial penalties for non-compliance. While some public debate has characterised the policy as a form of “nanny state” intervention, the Bill represents one of the most ambitious tobacco control measures in recent UK history, aiming to protect future generations from nicotine addiction and related harms.

Therefore, this analysis introduces the Tobacco and Vapes Bill within the 2027 model cycle, assuming that individuals turning 18 in 2027 will be the first cohort affected by the policy. The model applies a year-on-year reduction in initiation rates, meaning the effect compounds over time as younger cohorts progressively enter the population under the new legislation. However, as there is currently no empirical evidence quantifying the potential impact of the Bill, the effect must be modelled through assumptions. Accordingly, Scenarios 1–4 represent varying levels of reduction in smoking initiation rates, modelled as 10%, 30%, 60%, and 90% decreases, respectively, relative to the baseline scenario of no policy intervention.

The results show that for those among 14 to 30 years old, smoking prevalence is projected to decline to 4.13% by 2047 under Scenario 1 (10% reduction in initiation rate), while Scenario 2 (30% reduction) reaches 2.1% in the same year. Scenarios 3 and 4, representing larger reductions of 60% and 90%, produced almost identical trends, with prevalence stabilising at 1.97% by 2047.

```{r}
#| echo: false
all_scenario <- read_excel("C:/Users/TMPACGAG/OneDrive - Birmingham City Council/Documents/R projects/addiction team/smoking prevalence projection/result/all_scenario.xlsx")

plot2 = all_scenario%>%
  mutate(State_new = State,
         State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
  filter(State_new!= "Deaths") %>% 
  filter(Age %in% c(14:30)) %>% 
  group_by(Year, State_new,Scenario) %>%
  summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
  mutate(newgroup = ifelse(State_new == "Current smoker",
                           "Current smoker",
                           "Former and non")) %>% 
  group_by(Year,newgroup ,Scenario) %>% 
  summarise(numerator = sum(Total)) %>% 
  ungroup() %>% 
  group_by(Year,Scenario) %>% 
  mutate(denominator =sum(numerator)) %>% 
  ungroup() %>% 
  filter(newgroup == "Current smoker") %>% 
  mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
  filter(Year >=2026) %>% 
  mutate(tooltip = paste0("Year: ", Year,"\n",
                          "Scenario: ", factor(Scenario),"\n",
                          "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")) %>% 
  ggplot(aes(x = Year, y = smoking_prev, group = factor(Scenario), colour = factor(Scenario))) +
  geom_line_interactive(size=1, aes(data_id = paste(Scenario)))+
  geom_line_interactive(
    data = all_scenario %>%
      mutate(State_new = State,
             State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
      filter(State_new != "Deaths") %>% 
      filter(Age %in% c(14:30)) %>% 
      group_by(Year, State_new, Scenario) %>%
      summarise(Total = sum(Count, na.rm = TRUE), .groups="drop") %>% 
      mutate(newgroup = ifelse(State_new == "Current smoker", "Current smoker", "Former and non")) %>% 
      group_by(Year, newgroup, Scenario) %>% 
      summarise(numerator = sum(Total)) %>% 
      ungroup() %>% 
      group_by(Year, Scenario) %>% 
      mutate(denominator = sum(numerator)) %>% 
      ungroup() %>% 
      filter(newgroup == "Current smoker") %>% 
      mutate(smoking_prev = numerator / denominator,
             Year = as.numeric(as.character(Year))) %>% 
      filter(Year >= 2023 & Year <= 2026, Scenario == 0) %>% 
      mutate(tooltip = paste0("Year: ", Year, "\n",
                              "Scenario: ", factor(Scenario), "\n",
                              "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),
    size = 1, colour = "#3c3c3b", linetype = 2,aes(data_id = paste(Scenario))
  )+
  geom_point_interactive(data = all_scenario%>%
                           mutate(State_new = State,
                                  State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
                           filter(State_new!= "Deaths") %>% 
                           filter(Age %in% c(14:30)) %>% 
                           group_by(Year, State_new,Scenario) %>%
                           summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
                           mutate(newgroup = ifelse(State_new == "Current smoker",
                                                    "Current smoker",
                                                    "Former and non")) %>% 
                           group_by(Year,newgroup ,Scenario) %>% 
                           summarise(numerator = sum(Total)) %>% 
                           ungroup() %>% 
                           group_by(Year,Scenario) %>% 
                           mutate(denominator =sum(numerator)) %>% 
                           ungroup() %>% 
                           filter(newgroup == "Current smoker") %>% 
                           mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
                           filter(Year >=2026) %>% 
                           mutate(tooltip = paste0("Year: ", Year,"\n",
                                                   "Scenario: ", factor(Scenario),"\n",
                                                   "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),aes(tooltip = tooltip, data_id = paste(Scenario)))+
  geom_point_interactive(data = all_scenario%>%
                           mutate(State_new = State,
                                  State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
                           filter(State_new!= "Deaths") %>% 
                           filter(Age %in% c(14:30)) %>% 
                           group_by(Year, State_new,Scenario) %>%
                           summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
                           mutate(newgroup = ifelse(State_new == "Current smoker",
                                                    "Current smoker",
                                                    "Former and non")) %>% 
                           group_by(Year,newgroup ,Scenario) %>% 
                           summarise(numerator = sum(Total)) %>% 
                           ungroup() %>% 
                           group_by(Year,Scenario) %>% 
                           mutate(denominator =sum(numerator)) %>% 
                           ungroup() %>% 
                           filter(newgroup == "Current smoker") %>% 
                           mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
                           filter(Year >= 2023 & Year <= 2026, Scenario == 0) %>% 
                           mutate(tooltip = paste0("Year: ", Year,"\n",
                                                   "Scenario: ", factor(Scenario),"\n",
                                                   "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),aes(tooltip = tooltip, data_id = paste(Scenario)), colour = "#3c3c3b")+
  theme_minimal(base_size = 14)+
  scale_y_continuous(limits = c(0,0.15), labels = scales::percent)+
  scale_x_continuous(breaks = c(2023:2047))+
  labs(title = "Modelled smoking prevalence in Birmingham among 14 to 30 year olds for each scenario \n assuming the Tobacco and Vape Bill comes in effect in 2027",
       y="Prevalence",
       colour = "Scenario") +
  scale_color_manual(values = c(
    "0" = "#3c3c3b",
    "1" = "#D00070",
    "2" = "#FFAD00",
    "3" = "#75BC22",
    "4" = "#84329B"
  ),
  labels = c("baseline",
             "-10% in instigation",
             "-30% in institgation",
             "-60% in instigation",
             "-90% in instigation"))+
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle=45),
        legend.position = "bottom")


#custom css
tooltip_css = "
  border-radius: 12px;
  color: #333;
  background-color: white;
  padding: 10px;
  font-size: 14px;
  transition: all 0.5s ease-out;
"
girafe( ggobj = plot2, 
        options = list( opts_hover(css=" "), 
                        opts_hover_inv(css = girafe_css( css = "opacity:0.4;",
                                                         line = "opacity:0.075;", 
                                                         point = "opacity:0.075;" )), 
                        opts_tooltip(css = tooltip_css) ))



###################################################################




```

The results show that for adults (18+), smoking prevalence is projected to decline to 3.98% by 2047 under Scenario 1 (10% reduction in initiation rate), while Scenario 2 (30% reduction) reaches 2.97% in the same year. Scenarios 3 and 4, representing larger reductions of 60% and 90%, produced almost identical trends, with prevalence stabilising at approximately 2.7% by 2047.

```{r}
#| echo: false
all_scenario <- read_excel("C:/Users/TMPACGAG/OneDrive - Birmingham City Council/Documents/R projects/addiction team/smoking prevalence projection/result/all_scenario.xlsx")

plot4 = all_scenario%>%
  mutate(State_new = State,
         State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
  filter(State_new!= "Deaths") %>% 
  filter(Age %in% c(18:100)) %>% 
  group_by(Year, State_new,Scenario) %>%
  summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
  mutate(newgroup = ifelse(State_new == "Current smoker",
                           "Current smoker",
                           "Former and non")) %>% 
  group_by(Year,newgroup ,Scenario) %>% 
  summarise(numerator = sum(Total)) %>% 
  ungroup() %>% 
  group_by(Year,Scenario) %>% 
  mutate(denominator =sum(numerator)) %>% 
  ungroup() %>% 
  filter(newgroup == "Current smoker") %>% 
  mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
  filter(Year >=2026) %>% 
  mutate(tooltip = paste0("Year: ", Year,"\n",
                          "Scenario: ", factor(Scenario),"\n",
                          "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")) %>% 
  ggplot(aes(x = Year, y = smoking_prev, group = factor(Scenario), colour = factor(Scenario))) +
  geom_line_interactive(size=1, aes(data_id = paste(Scenario)))+
  geom_line_interactive(
    data = all_scenario %>%
      mutate(State_new = State,
             State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
      filter(State_new != "Deaths") %>% 
      filter(Age %in% c(18:100)) %>% 
      group_by(Year, State_new, Scenario) %>%
      summarise(Total = sum(Count, na.rm = TRUE), .groups="drop") %>% 
      mutate(newgroup = ifelse(State_new == "Current smoker", "Current smoker", "Former and non")) %>% 
      group_by(Year, newgroup, Scenario) %>% 
      summarise(numerator = sum(Total)) %>% 
      ungroup() %>% 
      group_by(Year, Scenario) %>% 
      mutate(denominator = sum(numerator)) %>% 
      ungroup() %>% 
      filter(newgroup == "Current smoker") %>% 
      mutate(smoking_prev = numerator / denominator,
             Year = as.numeric(as.character(Year))) %>% 
      filter(Year >= 2023 & Year <= 2026, Scenario == 0) %>% 
      mutate(tooltip = paste0("Year: ", Year, "\n",
                              "Scenario: ", factor(Scenario), "\n",
                              "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),
    size = 1, colour = "#3c3c3b", linetype = 2,aes(data_id = paste(Scenario))
  )+
  geom_point_interactive(data = all_scenario%>%
                           mutate(State_new = State,
                                  State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
                           filter(State_new!= "Deaths") %>% 
                           filter(Age %in% c(18:100)) %>% 
                           group_by(Year, State_new,Scenario) %>%
                           summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
                           mutate(newgroup = ifelse(State_new == "Current smoker",
                                                    "Current smoker",
                                                    "Former and non")) %>% 
                           group_by(Year,newgroup ,Scenario) %>% 
                           summarise(numerator = sum(Total)) %>% 
                           ungroup() %>% 
                           group_by(Year,Scenario) %>% 
                           mutate(denominator =sum(numerator)) %>% 
                           ungroup() %>% 
                           filter(newgroup == "Current smoker") %>% 
                           mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
                           filter(Year >=2026) %>% 
                           mutate(tooltip = paste0("Year: ", Year,"\n",
                                                   "Scenario: ", factor(Scenario),"\n",
                                                   "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),aes(tooltip = tooltip, data_id = paste(Scenario)))+
  geom_point_interactive(data = all_scenario%>%
                           mutate(State_new = State,
                                  State_new = ifelse(grepl("Ex", State),"Ex-smoker", State_new)) %>% 
                           filter(State_new!= "Deaths") %>% 
                           filter(Age %in% c(18:100)) %>% 
                           group_by(Year, State_new,Scenario) %>%
                           summarise(Total = sum(Count, na.rm=TRUE), .groups="drop") %>% 
                           mutate(newgroup = ifelse(State_new == "Current smoker",
                                                    "Current smoker",
                                                    "Former and non")) %>% 
                           group_by(Year,newgroup ,Scenario) %>% 
                           summarise(numerator = sum(Total)) %>% 
                           ungroup() %>% 
                           group_by(Year,Scenario) %>% 
                           mutate(denominator =sum(numerator)) %>% 
                           ungroup() %>% 
                           filter(newgroup == "Current smoker") %>% 
                           mutate(smoking_prev = numerator/denominator,Year = as.numeric(as.character(Year))) %>% 
                           filter(Year >= 2023 & Year <= 2026, Scenario == 0) %>% 
                           mutate(tooltip = paste0("Year: ", Year,"\n",
                                                   "Scenario: ", factor(Scenario),"\n",
                                                   "Smoking Prevalence: ", round(smoking_prev*100,2), "%", "\n")),aes(tooltip = tooltip, data_id = paste(Scenario)), colour = "#3c3c3b")+
  theme_minimal(base_size = 14)+
  scale_y_continuous(limits = c(0,0.15), labels = scales::percent)+
  scale_x_continuous(breaks = c(2023:2047))+
  labs(title = "Modelled smoking prevalence in Birmingham 18+ for each scenario \n assuming the Tobacco and Vape Bill comes in effect in 2027",
       y="Prevalence",
       colour = "Scenario") +
  scale_color_manual(values = c(
    "0" = "#3c3c3b",
    "1" = "#D00070",
    "2" = "#FFAD00",
    "3" = "#75BC22",
    "4" = "#84329B"
  ),
  labels = c("baseline",
             "-10% in instigation",
             "-30% in institgation",
             "-60% in instigation",
             "-90% in instigation"))+
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle=45),
        legend.position = "bottom")


#custom css
tooltip_css = "
  border-radius: 12px;
  color: #333;
  background-color: white;
  padding: 10px;
  font-size: 14px;
  transition: all 0.5s ease-out;
"
girafe( ggobj = plot4, 
        options = list( opts_hover(css=" "), 
                        opts_hover_inv(css = girafe_css( css = "opacity:0.4;",
                                                         line = "opacity:0.075;", 
                                                         point = "opacity:0.075;" )), 
                        opts_tooltip(css = tooltip_css) ))



###################################################################



```

## Limitation

In developing the model, several assumptions and simplifications were necessary, and as such, the findings should be interpreted in light of these limitations.

**Firstly**, The model does not explicitly incorporate vaping behaviour, if vaping became a substitute for smoking in the younger cohorts, the model may overstate the decline in nicotine consumption, since no information of vaping is incorporated to the model, individuals who vape are classified as non-smokers within the current framework. **Secondly**, the model does not incorporate information on how long former smokers have been abstinent. All individuals entering the ex-smoker state are assumed to have quit for one year at the start of each cycle, which may overestimate their likelihood of relapse compared to those who have remained smoke-free for longer periods. The model applies England’s average smoking prevalence to all net migrants, even though individuals arriving from other countries may have distinct smoking behaviours and cessation histories. Given this limitation, net migration may be negative for ex-smoker states, particularly among older age groups, reflecting Birmingham’s overall pattern of net out-migration at older ages. However, because negative values cannot be represented within Markov state transitions, the model constrains these values to zero. This adjustment ensures model stability but may slightly underestimate the outflow of older former smokers in the projected population structure. Fortunately, the extent of net out-migration of ex-smoker states among older age groups was relatively modest, and therefore is unlikely to have a substantial impact on the overall model outcomes. **Thirdly**, parameter uncertainty for transition probabilities can not be assessed, as the data sources used did not provide associated confidence intervals or measures of variability.
